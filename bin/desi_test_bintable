#!/usr/bin/env python
#
# Test memory-mapped files on NERSC filesystems. See
# https://docs.scipy.org/doc/numpy/reference/generated/numpy.memmap.html
#
import os
import sys

import numpy as np

from desiutil.log import get_logger
import desispec.io

def main():
    """Entry-point for command-line script.
    """
    os.environ['DESI_LOGLEVEL'] = 'DEBUG'
    log = get_logger()
    testdirs = (os.path.join(os.environ['DESI_ROOT'], 'users', os.environ['USER']),  # /global/project
                os.path.join(os.environ['DESI_ROOT'], 'datachallenge'),  # /global/projecta
                os.environ['HOME'],
                os.environ['SCRATCH'])
    filenames = [os.path.join(d, 'empty_fibermap.fits') for d in testdirs]

    for filename in filenames:
        fm = desispec.io.empty_fibermap(500)
        try:
            desispec.io.write_fibermap(filename, fm)
        except OSError as e:
            assert e.errno == 38
            assert e.strerror == 'Function not implemented'
            log.error("OSError detected for %s.", filename)
            continue
        except Exception as ee:
            log.error("Some other exception was raised for %s: %s.", filename, str(ee))
        else:
            log.info("No error detected for %s.", filename)
    return 0

sys.exit(main())
