#!/usr/bin/env python
#
# Test memory-mapped files on NERSC filesystems. See
# https://docs.scipy.org/doc/numpy/reference/generated/numpy.memmap.html
#
import os
import numpy as np

filenames = ('/global/project/projectdirs/desi/users/bweaver/testfile.dat',
             os.path.join(os.environ['SCRATCH'], 'testfile.dat'))

for filename in filenames:
    if os.path.exists(filename):
        os.remove(filename)

    data = np.arange(12, dtype=np.float32)
    data.resize((3, 4))

    try:
        fp = np.memmap(filename, dtype=np.float32, mode='w+', shape=(3, 4))
    except OSError as e:
        assert e.errno == 38
        assert e.strerror == 'Function not implemented'
        print("OSError detected for {0}.".format(filename))
        continue

    fp[:] = data[:]

    del fp

    fpr = np.memmap(filename, dtype=np.float32, mode='r', shape=(3, 4))

    assert np.allclose(fpr, data)

    print("No errors detected for {0}".format(filename))
