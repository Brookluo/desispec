#!/usr/bin/env python
#
# See top-level LICENSE.rst file for Copyright information
#
# -*- coding: utf-8 -*-

"""
Setup pipeline reduction from scratch
"""

from __future__ import absolute_import, division, print_function

import sys
import os
import numpy as np
import argparse
import re

import desispec.io as io

import desispec.pipeline as pipe


def main():
    parser = argparse.ArgumentParser(description='Set up pipeline runs for a production.')
    parser.add_argument('--raw', required=True, default=None, help='raw data directory')
    parser.add_argument('--redux', required=True, default=None, help='output directory')
    parser.add_argument('--prod', required=False, default='test', help='output production name')
    parser.add_argument('--nights', required=False, default=None, help='comma separated (YYYYMMDD) or regex pattern')
    parser.add_argument('--desimodel', required=False, default='/project/projectdirs/desi/software/edison/desimodel/trunk', help='desimodel checkout to use')
    parser.add_argument('--aux', required=False, default='/project/projectdirs/desi', help='root directory containing auxiliary data files')
    parser.add_argument('--basis', required=False, default='spectro/templates/basis_templates/v1.1', help='basis template directory, relative to the aux root')
    parser.add_argument( '--simraw', required=False, action='store_true', help='if set, raw data is simulated' )

    args = parser.parse_args()

    rawdir = os.path.abspath(args.raw)

    specdir = os.path.abspath(args.redux)

    # Create the output directories if needed

    if not os.path.isdir(specdir):
        os.makedirs(specdir)

    proddir = os.path.join(specdir, args.prod)
    if not os.path.isdir(proddir):
        os.makedirs(proddir)
    
    cal2d = os.path.join(proddir, 'calib2d')
    if not os.path.isdir(cal2d):
        os.makedirs(cal2d)

    calpsf = os.path.join(cal2d, 'psf')
    if not os.path.isdir(calpsf):
        os.makedirs(calpsf)

    expdir = os.path.join(proddir, 'exposures')
    if not os.path.isdir(expdir):
        os.makedirs(expdir)

    # Get full list of nights

    allnights = []
    nightpat = re.compile(r'\d{8}')
    for root, dirs, files in os.walk(rawdir, topdown=True):
        for d in dirs:
            nightmat = nightpat.match(d)
            if nightmat is not None:
                allnights.append(d)
        break

    # Trim list of nights based on set of patterns

    nights = []
    if args.nights is not None:
        nightsel = args.nights.split(',')
        for sel in nightsel:
            pat = re.compile(sel)
            for nt in allnights:
                mat = pat.match(nt)
                if mat is not None:
                    if nt not in nights:
                        nights.append(nt)
        nights = sorted(nights)
    else:
        nights = sorted(allnights)

    # create per-night directories

    for nt in nights:
        ndir = os.path.join(expdir, nt)
        if not os.path.isdir(ndir):
            os.makedirs(ndir)
        ndir = os.path.join(cal2d, nt)
        if not os.path.isdir(ndir):
            os.makedirs(ndir)
        ndir = os.path.join(calpsf, nt)
        if not os.path.isdir(ndir):
            os.makedirs(ndir)

    # create setup shell snippet

    setupfile = os.path.join(proddir, 'setup.sh')
    with open(setupfile, 'w') as s:
        s.write("# Generated by desi_pipe\n")
        s.write("export DESI_ROOT={}\n".format(os.path.abspath(args.aux)))
        s.write("export DESI_BASIS_TEMPLATES={}\n".format(os.path.abspath(os.path.join(args.aux, args.basis))))
        s.write("export DESI_SPECTRO_DATA={}\n".format(rawdir))
        s.write("export DESI_SPECTRO_REDUX={}\n".format(specdir))
        s.write("export PRODNAME={}\n".format(args.prod))
        s.write("\n")

    # create scripts for processing

    scrdir = os.path.join(proddir, 'scripts')
    if not os.path.isdir(scrdir):
        os.makedirs(scrdir)

    logdir = os.path.join(proddir, 'logs')
    if not os.path.isdir(logdir):
        os.makedirs(logdir)

    if args.simraw:
        pixroot = "pix"
    else:
        pixroot = "raw"

    for nt in nights:
        # get the list of exposures and their types
        (expid, exptype, fibermap, fullraw) = pipe.find_raw(rawdir, nt, simraw=args.simraw)
        
        # make nightly script and log directories
        nsdir = os.path.join(scrdir, nt)
        if not os.path.isdir(nsdir):
            os.makedirs(nsdir)
        nldir = os.path.join(logdir, nt)
        if not os.path.isdir(nldir):
            os.makedirs(nldir)

        # create scripts to run bootcalib
        firstarc = None
        for ex in expid:
            if exptype[ex] == "arc":
                firstarc = ex
                break
        firstflat = None
        for ex in expid:
            if exptype[ex] == "flat":
                firstflat = ex
                break
        commands = []
        for band in ['r', 'b', 'z']:
            flatname = "{}-{}0-{:08d}.fits".format(pixroot, band, firstflat)
            flatfile = os.path.join(rawdir, nt, flatname)
            arcname = "{}-{}0-{:08d}.fits".format(pixroot, band, firstarc)
            arcfile = os.path.join(rawdir, nt, arcname)
            outname = "psfboot-{}.fits".format(band)
            outfile = os.path.join(calpsf, nt, outname)
            commands.append("desi_bootcalib.py --fiberflat {} --arcfile {} --outfile {}".format(flatfile, arcfile, outfile))
        shell_file = os.path.join(nsdir, "bootcalib.sh")
        nersc_file = os.path.join(nsdir, "bootcalib.slurm")
        shell_log = os.path.join(nldir, "bootcalib_sh")
        nersc_log = os.path.join(nldir, "bootcalib_slurm")
        pipe.shell_job(shell_file, shell_log, [], commands)
        pipe.nersc_job(nersc_file, nersc_log, [], commands, nodes=1, nodeproc=1, minutes=30, openmp=False, multiproc=False)



if __name__ == "__main__":
    main()

